<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cart">
	
	<insert id="insert" parameterType="cartvo">

		<selectKey keyProperty="cartNo" resultType="long" order="BEFORE">
			
			delete from cart
			where 
			<if test="memberId != null">
				member_id=#{memberId} and product_no=#{productNo};
			</if>
			<if test="memberId == null">
				nonmember_mac=#{nonmemberMac} and product_no=#{productNo};
			</if>
		
			SET FOREIGN_KEY_CHECKS=0;
			
			insert into cart
			values(default, #{memberId}, #{nonmemberMac}, #{productNo}, #{quantity});
			
			SET FOREIGN_KEY_CHECKS=1;
			
			select last_insert_id() as cartNo;
		</selectKey>

		insert into cart_product_option
		values
		<foreach collection="productOptionDetailNo" item="item" separator=" , ">
			(default, #{cartNo}, #{item})
		</foreach>
	</insert>
	
	<select id="isValidAdd" parameterType="cartvo" resultType="int">
		select count(*)
		from product a
		join product_manage b on a.product_manage_no = b.no
		join product_option c on a.no = c.product_no
		join product_option_detail d on c.no = d.option_no
		where a.no=#{productNo} and b.isdisplay=true and d.no in
		<foreach collection="productOptionDetailNo" item="item" open="(" close=")" separator=",">
		 	#{item}
		 </foreach>
	</select>
	
</mapper>